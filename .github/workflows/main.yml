name: 自动更新

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * *'
  push:
    branches:
      - '*'

env:
  # 备份文件
  bhwj: 0
  # 获取上游
  hqsy: 0
  # 混淆文件
  hxwj: 0
  # 删除 .gitignore 文件
  scwj: 1
  # 清理目录
  qlml: 1
  # 清理非必要文件
  qlwj: 1
  # 下载文件
  xzwj: 1

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  zdgx:
    if: github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, '运行成功')
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.pat }}
      
      - name: 清理非必要文件
        if: env.qlwj == '1'
        run: |
          shopt -s extglob
          rm -rf !(.github|README.md)
      
      - name: 清理 .github 目录
        if: env.qlml == '1'
        run: |
          find .github -mindepth 1 ! -path ".github/workflows" ! -path ".github/workflows/*" -exec rm -rf {} +
          find .github/workflows/ -mindepth 1 ! -name "main.yml" -exec rm -rf {} +
      
      - name: 删除 .gitignore 文件
        if: env.scwj == '1'
        run: |
          if [ -f .gitignore ]; then
            rm -f .gitignore && echo "成功删除"
          else
            echo ".gitignore 文件不存在"
          fi
      
      - name: 提交并推送更新
        run: |
          git add .
          git status
          git commit -m '运行成功' || true
          git push origin ${{ github.ref }} --force
      
      - name: 安装 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: lts/*
      
      - name: 安装混淆工具
        run: npm install -g javascript-obfuscator
      
      - name: 设置 Git 用户信息
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: 备份工作流文件
        run: cp .github/workflows/main.yml /tmp/main.yml
      
      - name: 设置 Git 远程地址
        run: git remote set-url origin https://${{ github.actor }}:${{ secrets.pat }}@github.com/${{ github.repository }}.git
      
      - name: 获取上游仓库信息
        if: env.hqsy == '1'
        run: |
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.pat }}" "https://api.github.com/repos/${{ github.repository }}")
          UPSTREAM_REPO=$(echo "$RESPONSE" | jq -r '.parent.full_name')
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.pat }}" "https://api.github.com/repos/$UPSTREAM_REPO" | jq -r '.default_branch')
          git remote get-url upstream || git remote add upstream https://${{ secrets.pat }}@github.com/$UPSTREAM_REPO.git
          git fetch upstream
          git reset --hard upstream/$DEFAULT_BRANCH
      
      - name: 恢复工作流文件
        run: |
          mkdir -p .github/workflows
          cp /tmp/main.yml .github/workflows/main.yml
      
      - name: 自定义备份文件
        if: env.bhwj == '1'
        run: cp _worker.js /tmp/_worker.js
      
      - name: 二次清理非必要文件
        if: env.qlwj == '1'
        run: |
          shopt -s extglob
          rm -rf !(.github|README.md|_worker.js)
      
      - name: 二次清理 .github 目录
        if: env.qlml == '1'
        run: |
          find .github -mindepth 1 ! -path ".github/workflows" ! -path ".github/workflows/*" -exec rm -rf {} +
          find .github/workflows/ -mindepth 1 ! -name "main.yml" -exec rm -rf {} +
      
      - name: 删除文件
        if: env.scwj == '1'
        run: |
          if [ -f .gitignore ]; then
            rm -f .gitignore && echo "成功删除"
          else
            echo ".gitignore 文件不存在"
          fi
      
      - name: 自定义恢复文件
        if: env.bhwj == '1'
        run: cp /tmp/_worker.js _worker.js
      
      - name: 下载上游 Release 文件
        if: env.xzwj == '1'
        run: |
          # 获取仓库信息
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.pat }}" "https://api.github.com/repos/${{ github.repository }}")
          
          # 检查是否是 fork 仓库并获取上游信息
          UPSTREAM_REPO=$(echo "$RESPONSE" | jq -r '.parent.full_name // empty')
          
          # 如果没有上游信息，使用默认上游
          if [ -z "$UPSTREAM_REPO" ] || [ "$UPSTREAM_REPO" == "null" ]; then
            echo "未检测到上游仓库，使用默认上游"
            UPSTREAM_REPO="bia-pain-bache/BPB-Worker-Panel"
          fi
          
          echo "上游仓库: $UPSTREAM_REPO"
          AUTHOR=$(echo "$UPSTREAM_REPO" | cut -d '/' -f 1)
          REPO=$(echo "$UPSTREAM_REPO" | cut -d '/' -f 2)
          
          # 获取最新 Release 的 worker.js 文件
          echo "正在获取 Release 信息..."
          DOWNLOAD_URL=$(curl -s "https://api.github.com/repos/$AUTHOR/$REPO/releases/latest" \
            | jq -r '.assets[] | select(.name | test("worker\\.js$")) | .browser_download_url' \
            | head -n 1)
          
          echo "下载 URL: $DOWNLOAD_URL"
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "未找到 Release 中的 worker.js 文件，尝试从源码获取"
            # 备用方案：直接克隆仓库
            git clone --depth 1 "https://github.com/$UPSTREAM_REPO" /tmp/upstream
            if [ -f "/tmp/upstream/_worker.js" ]; then
              cp "/tmp/upstream/_worker.js" _worker.js
              echo "从源码复制 _worker.js 成功"
            elif [ -f "/tmp/upstream/worker.js" ]; then
              cp "/tmp/upstream/worker.js" _worker.js
              echo "从源码复制 worker.js 成功"
            else
              echo "错误: 未找到 worker.js 文件"
              exit 1
            fi
          else
            echo "开始下载: $DOWNLOAD_URL"
            curl -sSL -o _worker.js "$DOWNLOAD_URL"
            echo "下载完成"
          fi
          
          # 验证文件是否存在
          if [ -f "_worker.js" ]; then
            echo "文件下载成功，大小: $(wc -c < _worker.js) 字节"
          else
            echo "错误: 文件下载失败"
            exit 1
          fi
      
      - name: 混淆 _worker.js
        if: env.hxwj == '1'
        run: |
          javascript-obfuscator _worker.js --output _worker.js \
            --compact true \
            --identifier-names-generator hexadecimal \
            --rename-globals true \
            --string-array true \
            --transform-object-keys true \
            --unicode-escape-sequence true
      
      - name: 提交并推送更新
        run: |
          git add .
          git status
          git commit -m '运行成功' || true
          git push origin ${{ github.ref }} --force
